<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}" ></link>
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <script src="{{ url_for('static', filename='all.js') }}"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <meta name="viewport" charset="utf-8" content="width=device-width, initial-scale=1.0">
</head>
<body>
  
  
  <div style="display:flex;">
    <div>
      <div style="display: flex; justify-content: space-evenly;">
        <input type="range" min="1975" max="2020" value="2020" class="slider" id="myRange" style="width: 80%;">
      
        <div style="display: flex;">
          <label for="index">compare size:</label>
          <select name="index" id="index">
          <option value="1">1</option>
          <option value="2">2</option>
          <option value="3">3</option>
          <option value="4">4</option>
          <option value="5">5</option>
          <option value="6">6</option>
          <option value="7">7</option>
          </select>
        </div>
      </div>
      
      <p style="text-align: center;">Year: <span id="demo"></span></p>
      <div id="map_canvas" ></div>
    </div>
    
    <div style="text-align: center;">
      <div style="display: flex; justify-content: space-evenly;">
        <button type="reset-btn">Reset</button>
        <div>
          Metric: <select id="selectAttr" style="width: 150px;"></select>
        </div>
      </div>
      <div id="line-chart"></div>
    </div>
  </div>
  <div id="pcp" ></div>
  <div id="chart"></div>
  <div id="barchart"></div>
</body>

<script type="text/javascript">

var countries=[];
/*var colorsg = new Map();
colorsg.set(1, '#4fa39c');
colorsg.set(2, '#68c4b4');
colorsg.set(3, '#fcecdc');
// colorsg.set(4, '#d62728');
colorsg.set(5, '#e9610b');
colorsg.set(4, '#fcc49b');*/
/*var colorsg = new Map();
colorsg.set(1, '#7895ac');
colorsg.set(2, '#c9dabd');
colorsg.set(3, '#f4f5e3');
// colorsg.set(4, '#d62728');
colorsg.set(5, '#ed6769');
colorsg.set(4, '#efac86');*/
var colorsg = new Map();
colorsg.set(5, '#037488');
colorsg.set(4, '#89bbbd');
colorsg.set(3, '#fdfbee');
colorsg.set(2, '#f5c0a2');
colorsg.set(1, '#d94620');


  var performance = new Map();
  performance.set('High performing democracy',5);
  performance.set('Mid-range performing democracy',4);
  performance.set('Weak democracy',3);
  performance.set('Hybrid Regime',2);
  performance.set('Authoritarian Regime',1);
  //console.log("countrylist");
  countrylist = {{ countrylist | safe }} ;
  
  //console.log("attributeslist");
  attributeslist = {{ attributeslist | safe }} ;
  
  d3.select("#selectCountry")
  .selectAll('myOptions')
  .data(countrylist)
  .enter()
  .append('option')
  .text(function (d) { return d; }) 
  .attr("value", function (d) { return d; }) 
  
  countrylist2 = countrylist
  countrylist2.unshift("None");
  d3.select("#selectCountry2")
  .selectAll('myOptions')
  .data(countrylist2)
  .enter()
  .append('option')
  .text(function (d) { return d; })
  .attr("value", function (d) { return d; }) 
  
 
  d3.select("#selectAttr")
  .selectAll('myOptions')
  .data(attributeslist)
  .enter()
  .append('option')
  .text(function (d) { return d; }) 
  .attr("value", function (d) { return d; }) 
  
  
  var slider = document.getElementById("myRange");
  var output = document.getElementById("demo");
  output.innerHTML = slider.value;
  var year='2020'
  
  slider.oninput = function() {
    output.innerHTML = this.value;
    year =this.value;
    drawPcpPlot('default',6,year,[])
    drawMap
	var attr = document.getElementById("selectAttr").value;
	CreateBarChartInverse(attr,year,'1');
	drawLinechart(countries, attr);
    google.load('visualization', '1', {packages: ['geochart'], callback: drawMap});
    piechart()
  }
  
  function drawMap() {   
    var mapdata = {{ mapdata | safe }} ;
    var data = google.visualization.arrayToDataTable(mapdata[year-1975]);
    
    var options = {
      colorAxis: {colors: ['#d94620','#f5c0a2', '#fdfbee', '#89bbbd','#037488']},
							
      dataMode: 'regions',
      backgroundColor: '#efefef',
      width: 850,
      height: 400
    };
    
    var container = document.getElementById('map_canvas');
    var chart = new google.visualization.GeoChart(container);
    
    function myClickHandler(){
      var selection = chart.getSelection();
      var message = '';
      for (var i = 0; i < selection.length; i++) {
        var item = selection[i];
        if (item.row != null && item.column != null) {
          message += '{row:' + mapdata[year-1975][item.row] + ',column:' + item.column + '}';
		  
        } else if (item.row != null) {
          message += '{row:' + mapdata[year-1975][item.row][0] + '}';
		  if(!countries.includes(mapdata[year-1975][item.row+1][0])){
			countries.push(mapdata[year-1975][item.row+1][0]);
			
		  }
		    var index = document.getElementById("index");
			var index_value = index.value;
		  if(countries.length==index_value)  {
				//console.log(item.row+1)
			  //console.log(mapdata[year-1975][item.row+1][0])
			  let slider1= document.getElementById("myRange");
			  let year1=slider1.value;
			  drawPcpPlot(mapdata[year-1975][item.row+1][0],6,year1,countries)
			  var attr = document.getElementById("selectAttr").value;
			  CreateBarChartInverse(attr,year1,'1');

			  drawLinechart( countries,attr)
			  countries=[]
			  }
		  
        } else if (item.column != null) {
          message += '{column:' + item.column + '}';
        }
      }
      if (message == '') {
        message = 'nothing';
      }
    }
    
    google.visualization.events.addListener(chart, 'select', myClickHandler);
    
    chart.draw(data, options);
  }
  google.load('visualization', '1', {packages: ['geochart'], callback: drawMap});
  drawPcpPlot('default',6,year,[])		
  piechart()

  var attr = document.getElementById("selectAttr").value;
  drawLinechart(countries, attr)
	let year1=slider.value;
	CreateBarChartInverse(attr,year1,'1');
  
  document.getElementById("selectAttr").onchange = function() {onchangeFunc()};

  function onchangeFunc() {
    var attr = document.getElementById("selectAttr").value;
    drawLinechart(countries, attr)
	
  }
  
  function drawLinechart(countriesArr, attr){
    // let colorArr = ["steelblue", "orange", "gray", "red", "green", "black", "yellow"]
    // let colorArr = ["#00a4e4", "#c1d82f", "#ffdd00", "#fbb034", "#ff0000", "#8a7967", "#6a737b"]
    // let colorArr = ["#00a4e4", "Chartreuse", "orange", "gold", "red", "brown", "black"]
    // let colorArr = ["RoyalBlue", "Cyan", "orange", "BlueViolet", "red", "brown", "black"]
    // let colorArr = ["RoyalBlue", "Cyan", "orange", "BlueViolet", "red", "#964F4C", "black"]
    let colorArr = ["RoyalBlue", "Cyan", "orange", "BlueViolet", "red", "Violet", "black"]
    document.getElementById("line-chart").innerHTML = ""
    
    var margin = { top: 30, right: 70, bottom: 70, left:50 },
    width = 800 - margin.left - margin.right,
    height = 450 - margin.top - margin.bottom;
    
    var svg = d3.select("#line-chart")
    .append("svg")
    .attr("width", width + margin.left + margin.right)
    .attr("height", height + margin.top + margin.bottom)
    .append("g")
    .attr("transform",
    "translate(" + margin.left + "," + margin.top + ")");
    
    // graph title
    svg.append("text")
    .attr("class", "astyle")
    .attr("transform", "translate(100,0)")
    .attr("x", 0.4*width)
    .attr("y", -10)
    .text("Changes over years")
    
    var g = svg.append("g")
    .attr("transform", "translate(" + margin.left + "," + margin.top + ")");
    
    dataArr = [];
    linechartdatafull = {{ linechartdata | safe }} ;
    if (countriesArr.length > 0 ){
      for (let i = 0; i < countriesArr.length; i++) {
        dataArr.push(linechartdatafull[countriesArr[i]][attr])
      }
    } else {
      //default country
      dataArr.push(linechartdatafull["United States"][attr])
    }
    
    
    for (let i = 0; i < dataArr.length; i++) {
      dataArr[i].forEach(function(d) {
          d.date = d3.timeParse("%Y-%m-%d")(d.date);
          d.value = +d.value;
      });
    }
    
    var minx = d3.min(dataArr[0], function(d) { return d.date; })
    var maxx = d3.max(dataArr[0], function(d) { return d.date; })
    for (let i = 0; i < dataArr.length; i++) {
      mini = d3.min(dataArr[i], function(d) { return d.date; })
      maxi = d3.max(dataArr[i], function(d) { return d.date; })
      if (minx > mini) { minx = mini; }
      if (maxx < maxi) { maxx = maxi; }
    }

    var x = d3.scaleTime()
      .domain([minx, maxx])
      .range([ 0, width ]);
    xAxis = svg.append("g")
      .attr("transform", "translate(0," + height + ")")
      .call(d3.axisBottom(x));

    // Add Y axis
    if (attr == "democratic_performance_numeric" ) {
      var y = d3.scaleLinear().domain([0, 5]).range([ height, 0 ]);
    } else {
      var y = d3.scaleLinear().domain([0, 1]).range([ height, 0 ]);
    }
    
    yAxis = svg.append("g").call(d3.axisLeft(y));

    svg.append("text")
    .attr("class", "labeltext")
    .attr("text-anchor", "middle") 
    .attr("transform", "translate(" + (-30) + "," + (height / 2) + ")rotate(-90)")
    .text("Metric");
    
    svg.append("text")
    .attr("class", "labeltext")
    .attr("text-anchor", "middle") 
    .attr("transform", "translate(" + (width/2) + "," + 1.16*height + ")") 
    .text("year");

    lineArr = [];
    for (let i = 0; i < dataArr.length; i++) {
      data = dataArr[i];
    // Add a clipPath: everything out of this area won't be drawn.
    var clip = svg.append("defs").append("svg:clipPath")
        .attr("id", "clip")
        .append("svg:rect")
        .attr("width", width )
        .attr("height", height )
        .attr("x", 0)
        .attr("y", 0);

    // Add brushing
    var brush = d3.brushX()                   // Add the brush feature using the d3.brush function
        .extent( [ [0,0], [width,height] ] )  // initialise the brush area: start at 0,0 and finishes at width,height: it means I select the whole graph area
        .on("end", updateChart)               // Each time the brush selection changes, trigger the 'updateChart' function

    // Create the line variable: where both the line and the brush take place
    lineArr.push(svg.append('g').attr("clip-path", "url(#clip)"))

    // Add the line
    
      // line.append("path")
      lineArr[i].append("path")
        .datum(data)
        .attr("class", "line"+i)  // I add the class line to be able to modify this line later on.
        .attr("fill", "none")
        .attr("stroke", colorArr[i])
        .attr("stroke-width", 1.5)
        .attr("d", d3.line()
          .x(function(d) { return x(d.date) })
          .y(function(d) { return y(d.value) })
          )
    
    // Add the brushing
    lineArr[i]
      .append("g")
        .attr("class", "brush")
        .call(brush);

    // A function that set idleTimeOut to null
    var idleTimeout
    function idled() { idleTimeout = null; }

    // A function that update the chart for given boundaries
    function updateChart() {

      // What are the selected boundaries?
      extent = d3.event.selection

      // If no selection, back to initial coordinate. Otherwise, update X axis domain
      if(!extent){
        if (!idleTimeout) return idleTimeout = setTimeout(idled, 350); // This allows to wait a little bit
        x.domain([ 4,8])
      }else{
        console.log("x.invert(extent[0])")
        console.log(x.invert(extent[0]).getFullYear())
        console.log("x.invert(extent[1])")
        console.log(x.invert(extent[1]).getFullYear())
        x.domain([ x.invert(extent[0]), x.invert(extent[1]) ])
        lineArr[i].select(".brush").call(brush.move, null) // This remove the grey brush area as soon as the selection has been done
      }

      // Update axis and line position
      xAxis.transition().duration(1000).call(d3.axisBottom(x))
      for (let j = 0; j < lineArr.length; j++) {
      lineArr[j]
          .select('.line'+j)
          .transition()
          .duration(1000)
          .attr("d", d3.line()
            .x(function(d) { return x(d.date) })
            .y(function(d) { return y(d.value) })
          )
      }
    }

    // If user double click, reinitialize the chart
    svg.on("dblclick",function(){
      for (let j = 0; j < lineArr.length; j++) {
      x.domain([minx, maxx])
      xAxis.transition().call(d3.axisBottom(x))
      lineArr[j]
        .select('.line'+j)
        .transition()
        .attr("d", d3.line()
          .x(function(d) { return x(d.date) })
          .y(function(d) { return y(d.value) })
      )
    }
    });

  }
    
    var legend_h = height
    if (countriesArr.length > 0){
      for (let i = 0; i < countriesArr.length; i++) {
        svg.append("circle").attr("cx", 70).attr("cy", legend_h -20 - 30*i).attr("r", 6).style("fill", colorArr[i])
        svg.append("text").attr("x", 90).attr("y", legend_h - 20 - 30*i).text(countriesArr[i]).style("font-size", "10px").attr("alignment-baseline","middle")
      }
    } else {
      svg.append("circle").attr("cx", 70).attr("cy", legend_h -20).attr("r", 6).style("fill", colorArr[0])
      svg.append("text").attr("x", 90).attr("y", legend_h - 20).text("United States").style("font-size", "10px").attr("alignment-baseline","middle")
    }
    
  }
  
  function piechart() {
    document.getElementById("chart").innerHTML = ""
    
    
    var dataall = {{ piedata | safe }} ;
    var data = dataall[year - 1975]
    
    var text = "";
    
    var width = 200;
    var height = 200;
    var thickness = 40;
    var duration = 750;
    var padding = 10;
    var opacity = .8;
    var opacityHover = 1;
    var otherOpacityOnHover = .8;
    var tooltipMargin = 13;
    
    var radius = Math.min(width - padding, height - padding) / 2;
    var color = d3.scaleOrdinal(d3.schemeCategory10);
    
    var svg = d3.select("#chart")
    .append('svg')
    .attr('class', 'pie')
    .attr('width', width)
    .attr('height', height);
    
    var g = svg.append('g')
    .attr('transform', 'translate(' + (width / 2) + ',' + (height / 2) + ')');
    
    var arc = d3.arc()
    .innerRadius(0)
    .outerRadius(radius);
    
    var pie = d3.pie()
    .value(function(d) {
      return d.value;
    })
    .sort(null);
    
    var path = g.selectAll('path')
    .data(pie(data))
    .enter()
    .append("g")
    .append('path')
    .attr('d', arc)
    .attr('fill', function(d, i)  { 
      var tmp=Object.values(Object.values(d)[0])[0];
      var indx=performance.get(tmp);
      return colorsg.get(indx)})
      .style('opacity', opacity)
      .style('stroke', 'white')
      .on("mouseover", function(d) {
        d3.selectAll('path')
        .style("opacity", otherOpacityOnHover);
        d3.select(this)
        .style("opacity", opacityHover);
        
        let g = d3.select("svg")
        .style("cursor", "pointer")
        .append("g")
        .attr("class", "tooltip")
        .style("opacity", 0);
        
        g.append("text")
        .attr("class", "name-text")
        .text(`${d.data.name} (${d.data.value})`)
        .attr('text-anchor', 'middle');
        
        let text = g.select("text");
        let bbox = text.node().getBBox();
        let padding = 2;
        g.insert("rect", "text")
        .attr("x", bbox.x - padding)
        .attr("y", bbox.y - padding)
        .attr("width", bbox.width + (padding * 2))
        .attr("height", bbox.height + (padding * 2))
        .style("fill", "white")
        .style("opacity", 0.75);
      })
      .on("click", function(d) {
        let text = d3.select('.tooltip text');
        value=text.node().innerHTML
        var slider = document.getElementById("myRange");
        var year = slider.value;
        if(value.includes("High")){
          drawPcpPlot('pie',1,year,[])	
        }
        if(value.includes("Mid-range")){
          drawPcpPlot('pie',2,year,[])
        }
        if(value.includes("Weak")){
          drawPcpPlot('pie',3,year,[])
        }
        if(value.includes("Hybrid")){
          drawPcpPlot('pie',4,year,[])	
        }
        if(value.includes("Authoritarian")){
          drawPcpPlot('pie',5,year,[])	
        }
        
      })
      .on("mouseout", function(d) {
        d3.select("svg")
        .style("cursor", "none")
        .select(".tooltip").remove();
        d3.selectAll('path')
        .style("opacity", opacity);
      })
      .on("touchstart", function(d) {
        d3.select("svg")
        .style("cursor", "none");
      })
      .each(function(d, i) {
        this._current = i;
      });
      
      let legend = d3.select("#chart").append('div')
      .attr('class', 'legend')
      .style('margin-top', '30px');
      
      let keys = legend.selectAll('.key')
      .data(data)
      .enter().append('div')
      .attr('class', 'key')
      .style('display', 'flex')
      .style('align-items', 'center')
      .style('margin-right', '20px');
      
      keys.append('div')
      .attr('class', 'symbol')
      .style('height', '10px')
      .style('width', '10px')
      .style('margin', '5px 5px')
      .style('background-color', function(d, i) { 
        //console.log(Object.values(d)[0]);
        var tmp=Object.values(d)[0];
        var indx=performance.get(tmp);
        return colorsg.get(indx)});
        
        keys.append('div')
        .attr('class', 'name')
        .text(d => `${d.name} (${d.value})`);
        
        keys.exit().remove();
      }


    </script> 
  </body>
  </html>