<!DOCTYPE html>
<html>
<head>
  <link rel="icon" href="data:;base64,iVBORw0KGgo=">
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}" ></link>
  <script src="https://d3js.org/d3.v4.min.js" charset="utf-8"></script>
  <script src="{{ url_for('static', filename='all.js') }}"></script>
  <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
  
  <meta name="viewport" charset="utf-8" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <input type="range" min="1975" max="2020" value="2020" class="slider" id="myRange" style="width: 840px;">
  <p>Year: <span id="demo"></span></p>
  <div id="map_canvas" ></div>
  <div id="pcp" ></div>
  <div id="chart"></div>
</body>

<script type="text/javascript">
  var slider = document.getElementById("myRange");
  var output = document.getElementById("demo");
  output.innerHTML = slider.value;
  var year='2020'
  
  slider.oninput = function() {
    output.innerHTML = this.value;
    year =this.value;
    drawPcpPlot('test',6,year)
    data = google.visualization.arrayToDataTable(test[year-1975]);
    google.load('visualization', '1', {packages: ['geochart'], callback: drawMap});
  }
  function drawMap() {
    countries=[]
    var tmp=	['Country', 'DemocraticPerformance'];
    countriesList=[]
    countriesList.push(tmp);
    d3.csv("./static/data/newDemo.csv", function(data) {
      for (var i = 0; i < data.length; i++) {
        if (!countries.includes(data[i].country, 0)){
          tmp=[]
          countries.push(data[i].country);
          tmp.push(data[i].country);
          tmp.push(parseInt(data[i].democratic_performance_numeric));
          countriesList.push(tmp);
        }
      }
    });
    
    console.log("mydata");
    var test = {{ mydata_json | safe }} ;
    console.log(test);
    console.log("mydata end");
    
    //console.log(countriesList);
    var data = google.visualization.arrayToDataTable(test[year-1975]);
    
    var options = {
      colorAxis: {colors: ['#1f77b4','#2ca02c', '#9467bd','#d62728','#ff7f0e']},
      //['#1f77b4:5','#2ca02c: 4', '#9467bd: 3','#d62728: 2','#ff7f0e: 1']
      dataMode: 'regions',
      backgroundColor: '#efefef',
      width: 850,
      height: 400
    };
    
    var container = document.getElementById('map_canvas');
    var chart = new google.visualization.GeoChart(container);
    
    function myClickHandler(){
      var selection = chart.getSelection();
      var message = '';
      for (var i = 0; i < selection.length; i++) {
        var item = selection[i];
        if (item.row != null && item.column != null) {
          message += '{row:' + test[year-1975][item.row] + ',column:' + item.column + '}';
        } else if (item.row != null) {
          message += '{row:' + test[year-1975][item.row][0] + '}';
          drawPcpPlot(test[year-1975][item.row][0],6,year)	
        } else if (item.column != null) {
          message += '{column:' + item.column + '}';
        }
      }
      if (message == '') {
        message = 'nothing';
      }
    }
    
    google.visualization.events.addListener(chart, 'select', myClickHandler);
    
    chart.draw(data, options);
  }
  google.load('visualization', '1', {packages: ['geochart'], callback: drawMap});
  drawPcpPlot('test',6,year)		
  piechart()
</script> 
</body>
</html>